tables:
  - name: bottom_up_controlling
    sql: {{ load_sql('bottom_up_controlling') }}
    description: Bottom-up controlling data model combining invoice details mapping with invoice power data for comprehensive controlling analysis.
    public: true

    dimensions:
      - name: book
        type: string
        column: book
        description: "The book identifier for the transaction."

      - name: booking_month
        type: time
        column: booking_month
        description: "The month when the booking was made."

      - name: contract_name
        type: string
        column: contract_name
        description: "The name of the contract associated with the transaction."

      - name: country
        type: string
        column: country
        description: "The country where the transaction occurred."

      - name: cpty
        type: string
        column: cpty
        description: "The counterparty involved in the transaction."

      - name: customer
        type: string
        column: customer
        description: "The customer name."

      - name: delivery_month
        type: time
        column: delivery_month
        description: "The month when delivery is scheduled."

      - name: ent_inv
        type: string
        column: ent_inv
        description: "The entity invoice identifier."

      - name: installation_id
        type: string
        column: installation_id
        description: "The unique identifier for the installation."

      - name: invoice_booking_date
        type: time
        column: invoice_booking_date
        description: "The date when the invoice was booked."

      - name: invoice_is_cancellation
        type: boolean
        column: invoice_is_cancellation
        description: "Flag indicating if the invoice is a cancellation."

      - name: invoice_is_cancelled
        type: boolean
        column: invoice_is_cancelled
        description: "Flag indicating if the invoice has been cancelled."

      - name: invoice_number
        type: string
        column: invoice_number
        description: "The invoice number."

      - name: invoice_part
        type: string
        column: invoice_part
        description: "The part number of the invoice."

      - name: invoice_type
        type: string
        column: invoice_type
        description: "The type of invoice."

      - name: metering_code
        type: string
        column: metering_code
        description: "The metering code for the installation."

      - name: original_delivery_from
        type: time
        column: original_delivery_from
        description: "The original delivery start date."

      - name: original_delivery_to
        type: time
        column: original_delivery_to
        description: "The original delivery end date."

      - name: planned_start_date
        type: time
        column: planned_start_date
        description: "The planned start date for the contract."

      - name: planned_end_date
        type: time
        column: planned_end_date
        description: "The planned end date for the contract."

      - name: pod
        type: string
        column: pod
        description: "The point of delivery identifier."

      - name: report_asof_date
        type: time
        column: report_asof_date
        description: "The report as-of date."

      - name: segment
        type: string
        column: segment
        description: "The business segment."

      - name: split_delivery_from
        type: time
        column: split_delivery_from
        description: "The split delivery start date."

      - name: split_delivery_to
        type: time
        column: split_delivery_to
        description: "The split delivery end date."

      - name: sub_segment
        type: string
        column: sub_segment
        description: "The business sub-segment."

      - name: table_name
        type: string
        column: table_name
        description: "The source table name for data lineage tracking."

      - name: tnum
        type: string
        column: tnum
        description: "The transaction number."

      - name: tnumgroup
        type: string
        column: tnumgroup
        description: "The transaction number group."

      - name: volume_unit
        type: string
        column: volume_unit
        description: "The unit of measurement for volume."

      - name: zkey
        type: number
        column: zkey
        description: "The zkey identifier."

    measures:
      - name: inv_amt
        sql: "{TABLE.inv_amt}"
        type: sum
        description: "Total invoice amount."

      - name: original_total_amount
        sql: "{TABLE.original_total_amount}"
        type: sum
        description: "Total original amount."

      - name: split_amount
        sql: "{TABLE.split_amount}"
        type: sum
        description: "Split amount."

      - name: original_total_volume_mwh
        sql: "{TABLE.original_total_volume_mwh}"
        type: sum
        description: "Total original volume in MWh."

      - name: split_volume_mwh
        sql: "{TABLE.split_volume_mwh}"
        type: sum
        description: "Split volume in MWh."

      - name: vol_phys
        sql: "{TABLE.vol_phys}"
        type: sum
        description: "Physical volume."

      - name: count
        sql: "{TABLE.zkey}"
        type: count
        description: "Total number of records."

    segments:
      - name: invoice_details_mapping_records
        sql: "{TABLE.table_name} = 'invoice_details_map_position'"

      - name: invoice_power_records
        sql: "{TABLE.table_name} = 'tp_invoice_power'"

      - name: cancelled_invoices
        sql: "{TABLE.invoice_is_cancelled} = true"

      - name: cancellation_invoices
        sql: "{TABLE.invoice_is_cancellation} = true"

      - name: active_contracts
        sql: "{TABLE.planned_end_date} >= CURRENT_DATE"

      - name: has_installation_data
        sql: "{TABLE.installation_id} IS NOT NULL"

      - name: has_contract_data
        sql: "{TABLE.contract_name} IS NOT NULL" 